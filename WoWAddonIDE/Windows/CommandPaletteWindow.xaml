<Window x:Class="WoWAddonIDE.Windows.CommandPaletteWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Command Palette"
        Width="720" Height="520"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource App.BackgroundBrush}"
        Foreground="{DynamicResource App.ForegroundBrush}"
        KeyDown="Window_KeyDown"
        FocusManager.FocusedElement="{Binding ElementName=QueryBox}">

    <!-- Light-only, local fallbacks so the Designer never errors.
         If App.xaml defines these keys, those values will be used instead. -->
    <Window.Resources>
        <SolidColorBrush x:Key="App.BackgroundBrush" Color="#FFFDFDFD"/>
        <SolidColorBrush x:Key="App.ForegroundBrush" Color="#FF1E1E1E"/>
        <SolidColorBrush x:Key="Brush.Border"       Color="#FFCCCCCC"/>
    </Window.Resources>

    <Grid Margin="0" Background="{DynamicResource App.BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Search box + watermark -->
        <Grid Margin="12,12,12,6">
            <TextBox x:Name="QueryBox"
                     Height="34"
                     Padding="10,4"
                     FontSize="14"
                     VerticalContentAlignment="Center"
                     Background="{DynamicResource App.BackgroundBrush}"
                     Foreground="{DynamicResource App.ForegroundBrush}"
                     BorderBrush="{DynamicResource Brush.Border}"
                     TextChanged="QueryBox_TextChanged"
                     KeyDown="QueryBox_KeyDown"/>

            <!-- Watermark shown only when the box is empty -->
            <TextBlock Text="Type a command… (e.g., Build, Push, TOC, Symbol)"
                       Margin="14,0,8,0"
                       VerticalAlignment="Center"
                       IsHitTestVisible="False"
                       Opacity="0.55">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Text, ElementName=QueryBox}" Value="">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </Grid>

        <!-- Results -->
        <Border Grid.Row="1" Margin="12,0,12,12"
                BorderBrush="{DynamicResource Brush.Border}"
                BorderThickness="1">
            <ListBox x:Name="ResultsList"
                     Background="{DynamicResource App.BackgroundBrush}"
                     Foreground="{DynamicResource App.ForegroundBrush}"
                     MouseDoubleClick="ResultsList_MouseDoubleClick"
                     KeyDown="ResultsList_KeyDown"
                     ScrollViewer.CanContentScroll="True"
                     SelectionMode="Single">

                <!-- Virtualization set before measure to avoid XDG0066 -->
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel IsVirtualizing="True"
                                                VirtualizationMode="Recycling"/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="8,6">
                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                            <!-- Subtitle only when non-empty -->
                            <TextBlock Text="{Binding Subtitle}"
                                       Opacity="0.7"
                                       TextTrimming="CharacterEllipsis">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Subtitle}" Value="">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Subtitle}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>
    </Grid>
</Window>